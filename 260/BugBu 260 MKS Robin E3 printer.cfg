[include mainsail.cfg]
[include Adaptive_Mesh.cfg]
#[include KAMP_Settings.cfg]
[exclude_object]
#[include PIS.cfg]
[include led_progress.cfg]

[virtual_sdcard]
path: ~/printer_data/gcodes

# This file contains common pin mappings for MKS Robin E3 boards. To
# use this config, the firmware should be compiled for the STM32F103.
# When running "make menuconfig", enable "extra low-level
# configuration setup", select the 20KiB bootloader, and serial (on
# USART1 PA10/PA9) communication.

# Note that the "make flash" command does not work with MKS Robin
# boards. After running "make", run the following command:
#   ./scripts/update_mks_robin.py out/klipper.bin out/Robin_e3.bin
# Copy the file out/Robin_e3.bin to an SD card and then restart the
# printer with that SD card.

# MKS Robin E3 has onboard TMC2209. This config can also be used for
# MKS Robin E3D if equipped with TMC2209 stepper drivers.

# Please note pin name change for stepper Z for v1.1 of the boards.

# See docs/Config_Reference.md for a description of parameters.

[stepper_x]
step_pin: PC0
dir_pin: !PB2
enable_pin: !PC13
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop
#endstop_pin: ^PA12
position_endstop: -5
position_min:-6
position_max: 245
homing_speed: 50
homing_retract_dist: 0

[stepper_y]
step_pin: PC2
dir_pin: !PB9
enable_pin: !PB12
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: -5
position_min:-6
position_max: 235
homing_speed: 50
homing_retract_dist: 0

[stepper_z]
step_pin: PC14 # PC14 if using board v1.1
dir_pin: PC15 # !PC15 if using board v1.1
enable_pin: !PB8
microsteps: 16
rotation_distance: 8
endstop_pin: probe: z_virtual_endstop
position_max: 200
position_min: -10

[extruder]
max_extrude_only_distance: 400.0
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB5
microsteps: 16
rotation_distance: 5.46
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 250

[tmc2209 stepper_x]
uart_pin: PC7
run_current: 0.800
hold_current: 0.500
#stealthchop_threshold: 999999
diag_pin: ^PA12
driver_SGTHRS: 100 # 255 is most sensitive value, 0 is least sensitive

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 0.800
hold_current: 0.500
#stealthchop_threshold: 999999
diag_pin: ^PA11
driver_SGTHRS: 110

[tmc2209 stepper_z]
uart_pin: PC12
run_current: 0.800
hold_current: 0.450
#stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PC11
run_current: 0.800
hold_current: 0.500
#stealthchop_threshold: 999999

[fan]
pin: PA8

[heater_bed]
heater_pin: PC8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1
#control: pid
# tuned for stock hardware with 50 degree Celsius target
#pid_Kp: 54.027
#pid_Ki: 0.770
#pid_Kd: 948.182
min_temp: 0
max_temp: 130

[bltouch]
sensor_pin: ^PB1
control_pin: PA3
pin_up_touch_mode_reports_triggered: False
probe_with_touch_mode: True
x_offset: -26
y_offset: -14
#z_offset: 0

[safe_z_home]
home_xy_position: 130, 115 # Change coordinates to the center of your print bed
speed: 50
z_hop: 10                 # Move up 10mm
z_hop_speed: 5

[bed_mesh]
speed: 300
horizontal_move_z: 5
mesh_min: 25, 25
mesh_max: 200, 200
probe_count: 5,5
algorithm: bicubic
fade_start: 1
fade_end: 10
fade_target: 0

#[filament_switch_sensor my_sensor]
#switch_pin: PB10
#...

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 2000      #Max 4000
max_z_velocity: 15        #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

[neopixel my_led]
pin: PA2
chain_count: 32
# Use RGB values, must be between 0.0 and 0.1
initial_RED: 0.51
initial_GREEN: 0.0
initial_BLUE: 0.52


###########################################################################
## MACROS
###########################################################################


[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos  : True  ; use custom park coordinates for x,y [True/False] 
variable_custom_park_x   : 200.0   ; custom x position; value must be within your defined min and max of X
variable_custom_park_y   : 210.0    ; custom y position; value must be within your defined min and max of Y
variable_custom_park_dz  : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position 
variable_retract         : 1.0   ; the value to retract while PAUSE
variable_cancel_retract  : 5.0   ; the value to retract while CANCEL_PRINT
variable_speed_retract   : 35.0  ; retract speed in mm/s
variable_unretract       : 1.0   ; the value to unretract while RESUME
variable_speed_unretract : 35.0  ; unretract speed in mm/s
variable_speed_hop       : 15.0  ; z move speed in mm/s
variable_speed_move      : 120.0 ; move speed in mm/s
variable_park_at_cancel  : True  ; allow to move the toolhead to park while execute CANCEL_PRINT [True,False]
## !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
variable_use_fw_retract  : True  ; use fw_retraction instead of the manual version [True/False] 
gcode:


[gcode_macro UNLOAD_FILAMENT]
gcode:
 M83                   # Put the extruder into relative mode
 G92 E0.0              # Reset the extruder so that it thinks it is at position zero
 G1 E-350 F350          # Move the extruder backwards 350mm at a speed of 350mm/minute
 G92 E0.0              # Reset the extruder again
 M82                   # Put the extruder back into absolute mode.

[gcode_macro FILAMENT_LOAD]
gcode:
 M83                   # Put the extruder into relative mode
 G92 E0.0              # Reset the extruder so that it thinks it is at position zero
 G1 E350 F350          # Move the extruder forward 350mm at a speed of 350mm/minute
 G92 E0.0              # Reset the extruder again
 M82                   # Put the extruder back into absolute mode.

[gcode_macro M600]
description: Filament change
gcode: PAUSE X=10 Y=10 Z_MIN=50

[gcode_macro START_PRINT]
gcode:
  M104 S150 ; set temporary nozzle temp to prevent oozing during homing and auto bed leveling
  G4 S10 ; allow partial nozzle warmup
  {% set BED_TEMP = params.BED_TEMP|default(55)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(220)|float %}
  M140 S{BED_TEMP} ; Start bed heating
  G90 ; Use absolute coordinates
  G28 ; Home all axes
  BED_MESH_CALIBRATE 
  BED_MESH_PROFILE LOAD=default
  G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
  G1 X2 Y20 Z30 F5000.0 ; Move to start position
  M190 S{BED_TEMP} ; Wait for bed to reach temperature
  M109 S{EXTRUDER_TEMP} ; Set and wait for nozzle to reach temperature
  G1 Z1.28 F240
  G92 E0
  G1 Y140 E10 F1500 ; prime the nozzle
  G1 X2.3 F5000
  G92 E0
  G1 Y10 E10 F1200 ; prime the nozzle
  G92 E0

[gcode_macro PID_EXTRUDER]
description: PID Tune for the Extruder
gcode:
  {% set TARGET_TEMP = params.TARGET_TEMP|default(220)|float %} 
  PID_CALIBRATE HEATER=extruder TARGET={TARGET_TEMP}
  TURN_OFF_HEATERS
  SAVE_CONFIG

[gcode_macro PID_BED]
description: PID Tune for the Bed
gcode:
  {% set TARGET_TEMP = params.TARGET_TEMP|default(70)|float %} 
  PID_CALIBRATE HEATER=heater_bed TARGET={TARGET_TEMP}
  TURN_OFF_HEATERS
  SAVE_CONFIG

#[gcode_macro G29]				
gcode:
  G28
  bed_mesh_calibrate
  G1 X0 Y0 Z10 F4200

[Pause_Resume]
recover_velocity: 25

[gcode_macro Set_Z_Offset]
description: start process because I'm forgetful 
gcode:
    G28
    probe_calibrate

[gcode_macro PRIME_LINE]
gcode:
    M117 Prime Line
    G92 E0 ;Reset Extruder
    # move z axis
    G1 Z2.0 F3000 ;Move Z Axis up
    # move to prime position
    G1 X10 Y30 Z0.4 F5000.0 ;Move to start position
    G1 X10 Y200.0 Z0.4 F1500.0 E15 ;Draw the first line
    G1 X11 Y200.0 Z0.4 F5000.0 ;Move to side a little
    G1 X11 Y30 Z0.4 F1500.0 E30 ;Draw the second line
    #G1 E-0.2
    G92 E0 ;Reset Extruder
    G1 Z2.0 F3000 ;Move Z Axis up

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 26.184
#*# pid_ki = 1.800
#*# pid_kd = 95.243
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.540
#*# pid_ki = 1.274
#*# pid_kd = 976.102
#*#
#*# [bltouch]
#*# z_offset = 2.160
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.440000, -0.687500, -0.950000, -1.267500, -1.625000
#*# 	-0.042500, -0.262500, -0.507500, -0.767500, -1.097500
#*# 	0.372500, 0.157500, -0.057500, -0.297500, -0.565000
#*# 	0.837500, 0.670000, 0.500000, 0.302500, 0.040000
#*# 	1.347500, 1.232500, 1.062500, 0.895000, 0.667500
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 200.0
#*# min_y = 25.0
#*# max_y = 200.0
